---
- name: Wait for Grafana to be ready
  uri:
    url: "http://93.77.188.191:3000/api/health"
    method: GET
    status_code: 200
  register: grafana_health
  retries: 30
  delay: 10
  until: grafana_health.status == 200
  delegate_to: localhost
  run_once: yes
  become: no
  tags: [grafana, dashboards]

- name: Create Grafana Service Account
  uri:
    url: "http://93.77.188.191:3000/api/serviceaccounts"
    method: POST
    user: admin
    password: admin
    force_basic_auth: yes
    body_format: json
    body:
      name: "ansible-sa-{{ ansible_date_time.epoch }}"
      role: "Admin"
    status_code: 201
  register: grafana_sa
  delegate_to: localhost
  run_once: yes
  become: no
  tags: [grafana, dashboards]

- name: Create Grafana Service Account Token
  uri:
    url: "http://93.77.188.191:3000/api/serviceaccounts/{{ grafana_sa.json.id }}/tokens"
    method: POST
    user: admin
    password: admin
    force_basic_auth: yes
    body_format: json
    body:
      name: "ansible-token-{{ ansible_date_time.epoch }}"
    status_code: 200
  register: grafana_token
  delegate_to: localhost
  run_once: yes
  become: no
  tags: [grafana, dashboards]

- name: Import Node Exporter dashboard
  community.grafana.grafana_dashboard:
    grafana_url: "http://93.77.188.191:3000"
    grafana_api_key: "{{ grafana_token.json.key }}"
    dashboard_id: 1860
    overwrite: yes
  delegate_to: localhost
  run_once: yes
  become: no
  when: grafana_token.json.key is defined
  tags: [grafana, dashboards]

- name: Import Nginx dashboard
  community.grafana.grafana_dashboard:
    grafana_url: "http://93.77.188.191:3000"
    grafana_api_key: "{{ grafana_token.json.key }}"
    dashboard_id: 12559
    overwrite: yes
  delegate_to: localhost
  run_once: yes
  become: no
  when: grafana_token.json.key is defined
  tags: [grafana, dashboards]

- name: Clean up - Delete Service Account Token
  uri:
    url: "http://93.77.188.191:3000/api/serviceaccounts/{{ grafana_sa.json.id }}/tokens/{{ grafana_token.json.id }}"
    method: DELETE
    user: admin
    password: admin
    force_basic_auth: yes
    status_code: 200
  delegate_to: localhost
  run_once: yes
  become: no
  when: grafana_sa.json.id is defined and grafana_token.json.id is defined
  tags: [grafana, dashboards]

- name: Clean up - Delete Service Account
  uri:
    url: "http://93.77.188.191:3000/api/serviceaccounts/{{ grafana_sa.json.id }}"
    method: DELETE
    user: admin
    password: admin
    force_basic_auth: yes
    status_code: 200
  delegate_to: localhost
  run_once: yes
  become: no
  when: grafana_sa.json.id is defined
  tags: [grafana, dashboards]
  
  #####2

- name: Create Prometheus data source
  uri:
    url: "http://93.77.188.191:3000/api/datasources"
    method: POST
    user: admin
    password: admin
    force_basic_auth: yes
    body_format: json
    body:
      name: "Prometheus"
      type: "prometheus"
      url: "http://10.0.10.20:9090"
      access: "proxy"
      isDefault: true
    status_code: 200
  register: prometheus_ds_create
  delegate_to: localhost
  run_once: yes
  become: no
  ignore_errors: yes
  tags: [grafana, dashboards]

- name: Get Prometheus datasource UID (after creation)
  uri:
    url: "http://93.77.188.191:3000/api/datasources/name/Prometheus"
    method: GET
    user: admin
    password: admin
    force_basic_auth: yes
    status_code: 200
  register: prometheus_ds
  delegate_to: localhost
  run_once: yes
  become: no
  tags: [grafana, dashboards]
  
  #####
  
- name: Get Prometheus datasource UID
  uri:
    url: "http://93.77.188.191:3000/api/datasources/name/Prometheus"
    user: admin
    password: admin
    force_basic_auth: yes
    status_code: 200
  register: prometheus_ds
  delegate_to: localhost
  run_once: yes
  become: no
  tags: [grafana, dashboards]

- name: Update Node Exporter dashboard datasource
  uri:
    url: "http://93.77.188.191:3000/api/dashboards/uid/{{ item.uid }}"
    method: GET
    user: admin
    password: admin
    force_basic_auth: yes
    status_code: 200
  register: dashboard_json
  loop: "{{ (lookup('url', 'http://93.77.188.191:3000/api/search?query=Node%20Exporter', user='admin', password='admin', force_basic_auth=True) | from_json) }}"
  when: item.title | regex_search('Node Exporter')
  delegate_to: localhost
  run_once: yes
  become: no
  tags: [grafana, dashboards]

- name: Update dashboard with correct datasource
  uri:
    url: "http://93.77.188.191:3000/api/dashboards/db"
    method: POST
    user: admin
    password: admin
    force_basic_auth: yes
    body_format: json
    body:
      dashboard: "{{ dashboard_json.json.dashboard | combine({'panels': dashboard_json.json.dashboard.panels | map('combine', {'datasource': {'uid': prometheus_ds.json.uid}}) | list}, recursive=True) }}"
      overwrite: true
  when: dashboard_json.json is defined
  delegate_to: localhost
  run_once: yes
  become: no
  tags: [grafana, dashboards]
